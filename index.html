<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Booha Speak & Repeat – January Week 1</title>
<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#0b1530; --ink:#fff; --outline:#ffffff26;
  --ok:#22c55e; --heart:#ff4fa6;
  --radius:26px;
  --pink:#ff7eb9; --mint:#a6f7b2; --blue:#7dd3fc; --yellow:#fff680;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,"Noto Sans JP",sans-serif;-webkit-overflow-scrolling:touch;
}

/* Header */
header{text-align:center;padding:26px 12px 12px}
.h1{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(34px,6.2vw,56px);letter-spacing:.5px;text-transform:uppercase;}
.h2{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(22px,4.5vw,36px);margin-top:6px;}
.h3{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(16px,3.6vw,22px);margin-top:10px;opacity:.9;}
.h4{font-weight:800;font-size:clamp(14px,3.4vw,20px);color:#cfe1ff;margin-top:2px;}

.wrap{max-width:1100px;margin:0 auto;padding:8px 16px 80px}
.panel{padding:20px;border:1px solid var(--outline);border-radius:var(--radius);
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  box-shadow:0 6px 24px rgba(0,0,0,.4);}

/* Sentence card */
.card{border:1px solid var(--outline);border-radius:var(--radius);padding:18px 16px;margin-bottom:10px;
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));}
.en{font-weight:900;font-size:clamp(20px,4.8vw,28px);text-align:center}
.en .karaoke{display:inline-block}
.en .karaoke span{
  padding:0 .06em;border-radius:.18em;transition:filter .08s ease, opacity .08s ease, background .18s ease;
}
.en .karaoke span.on{
  background:linear-gradient(90deg,#24d781,#c7a600);
  color:#02150c;
  text-shadow:0 1px 0 rgba(255,255,255,.45);
  box-shadow:0 0 0 3px rgba(36,215,129,.22);
}
.jp{font-weight:700;font-size:clamp(16px,3.8vw,22px);text-align:center;color:#d8e7ff;margin-top:8px}
.hira{font-size:clamp(14px,3.4vw,18px);text-align:center;color:#bcd3ff;margin-top:6px}

@media (max-width:520px){
  .jp,.hira{max-width:92vw;margin-left:auto;margin-right:auto}
}

/* Under-sentence listening progress bar */
.listenBar{height:10px;border-radius:999px;border:1px solid var(--outline);margin:14px auto 0;max-width:860px;overflow:hidden}
.listenFill{height:100%;width:0;background:linear-gradient(90deg,#24d781,#0fb46a,#079a59);
  box-shadow:0 0 14px rgba(34,197,94,.7) inset,0 0 18px rgba(34,197,94,.4);}

/* Big circular detection meter */
.meterWrap{display:flex;align-items:center;justify-content:center;margin:22px 0}
.meter{
  width:min(56vw,260px);height:min(56vw,260px);border-radius:50%;
  background:conic-gradient(#2dd4bf 0deg,#60a5fa 60deg,#a78bfa 120deg,#f472b6 180deg,#facc15 240deg,#34d399 300deg,#2dd4bf 360deg);
  box-shadow:0 0 30px rgba(0,0,0,.35), inset 0 0 20px rgba(255,255,255,.08);
  position:relative;display:grid;place-items:center;transition:transform .08s ease;
}
.meter::after{
  content:"";
  position:absolute;inset:10px;border-radius:50%;
  background:radial-gradient(circle at 50% 40%, rgba(255,255,255,.22), rgba(255,255,255,.06));
}
.meterVal{
  position:relative;z-index:1;font-weight:900;font-size:clamp(18px,5vw,26px);
  text-shadow:0 2px 0 rgba(0,0,0,.35);
}

/* Buttons */
.btn{
  display:block;margin:16px auto 8px;border:none;border-radius:999px;
  padding:16px 36px;font-weight:900;font-size:clamp(18px,4vw,22px);
  background:radial-gradient(circle at 30% 30%,#1ee99a,#15c473,#0ea85d);
  color:#00230f;text-shadow:0 1px 0 rgba(255,255,255,.5);
  box-shadow:0 0 0 5px rgba(34,197,94,.22),0 0 18px rgba(34,197,94,.8);
  cursor:pointer;transition:opacity .2s ease, transform .05s ease;
}
.btn:active{transform:scale(.98)}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn.blue{
  background:radial-gradient(circle at 30% 30%, #66b3ff, #3e90ff, #1e6eff);
  color:#00163a;
  box-shadow:0 0 0 5px rgba(62,144,255,.25), 0 0 18px rgba(62,144,255,.85);
}

/* Progress + score box */
#progress{text-align:center;color:#cfe1ff;opacity:.9;font-weight:700;margin-top:6px}
.scoreBox{
  margin:16px auto 6px;max-width:600px;text-align:center;padding:14px 16px;border-radius:18px;border:1px solid var(--outline);
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  font-weight:900;font-size:clamp(18px,4.2vw,24px);
}
.scoreBox.good{box-shadow:0 0 28px rgba(34,197,94,.5) inset, 0 0 18px rgba(34,197,94,.35)}
.scoreBox.mid{box-shadow:0 0 28px rgba(96,165,250,.5) inset, 0 0 18px rgba(96,165,250,.35)}
.scoreBox.bad{box-shadow:0 0 28px rgba(229,57,53,.5) inset, 0 0 18px rgba(229,57,53,.35)}

/* FX layers */
.fx{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:1000}
.heart{position:absolute;color:var(--heart);font-size:clamp(46px,9vw,90px);text-shadow:0 4px 0 rgba(0,0,0,.35);animation:heartFly 1200ms ease-out forwards;}
@keyframes heartFly{0%{opacity:0;transform:translate(-50%,-20px) scale(.6)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-240px) scale(1.5)}}
.smoke{position:absolute;width:clamp(60px,15vw,160px);height:clamp(60px,15vw,160px);border-radius:50%;background:radial-gradient(circle at 40% 40%,#6a4d2b,rgba(133,80,24,.9) 60%,rgba(64,32,0,0) 72%);animation:smokeRise 1600ms ease-out forwards;filter:blur(1px);}
@keyframes smokeRise{0%{opacity:0;transform:translate(-50%,0) scale(.6)}20%{opacity:.9}100%{opacity:0;transform:translate(-50%,-260px) scale(1.4)}}

/* Footer */
footer{text-align:center;color:#c9d4ec;font-family:'Cinzel',serif;font-weight:700;padding:40px 10px}
.support{max-width:800px;margin:12px auto 0;text-align:center;color:#ffcf7f}
</style>
</head>
<body>
<header>
  <div class="h1">THE BOO-RICULUM</div>
  <div class="h2">SPEAK &amp; REPEAT</div>
  <div class="h3">January Week 1 – Speaking Practice</div>
  <div class="h4">１月第１週 – スピーキング練習</div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="card">
      <div id="en" class="en">Press Begin to start</div>
      <div id="jp" class="jp"></div>
      <div id="hira" class="hira"></div>
      <div class="listenBar"><div id="listenFill" class="listenFill"></div></div>
    </div>

    <div class="meterWrap">
      <div id="meter" class="meter"><div id="meterVal" class="meterVal">—%</div></div>
    </div>

    <button id="beginBtn" class="btn">Begin</button>
    <button id="nextBtn" class="btn blue" style="display:none">Next</button>

    <div id="progress">0 / 15（0%）</div>
    <div id="scoreBox" class="scoreBox" style="display:none">Score: —%</div>

    <div id="support" class="support" style="display:none">
      Speech Recognition is not supported on this browser.<br>
      Try Chrome or Edge for the full experience.
    </div>
  </div>
</div>

<!-- FX layer -->
<div id="fx" class="fx"></div>

<footer>Bryan’s English School</footer>

<script>
/* ===== Data (15 speaking prompts) ===== */
const ITEMS = [
  { en:"What is your goal this year?", jp:"今年の目標は何ですか。", hira:"(ことし の もくひょう は なん です か)" },
  { en:"Why is it important to you?", jp:"あなたにとってなぜ大切ですか。", hira:"(あなた に とって なぜ たいせつ です か)" },
  { en:"How will you reach your goal?", jp:"どうやって目標を達成しますか。", hira:"(どうやって もくひょう を たっせい します か)" },
  { en:"Who helps you stay motivated?", jp:"やる気を保つのを誰が助けてくれますか。", hira:"(やるき を たもつ の を だれ が たすけて くれ ます か)" },
  { en:"What habit do you want to change?", jp:"変えたい習慣は何ですか。", hira:"(かえたい しゅうかん は なん です か)" },
  { en:"Do you like making resolutions?", jp:"新年の目標を立てるのは好きですか。", hira:"(しんねん の もくひょう を たてる の は すき です か)" },
  { en:"What do you want to try this year?", jp:"今年挑戦したいことは何ですか。", hira:"(ことし ちょうせん したい こと は なん です か)" },
  { en:"What’s something new you learned recently?", jp:"最近新しく学んだことは何ですか。", hira:"(さいきん あたらしく まなんだ こと は なん です か)" },
  { en:"Is it easy to keep goals?", jp:"目標を続けるのは簡単ですか。", hira:"(もくひょう を つづける の は かんたん です か)" },
  { en:"What happens when you don’t try?", jp:"挑戦しないとどうなりますか。", hira:"(ちょうせん しない と どう なり ます か)" },
  { en:"What makes you feel proud?", jp:"何があなたを誇らしくさせますか。", hira:"(なに が あなた を ほこらしく させ ます か)" },
  { en:"What’s your dream for the future?", jp:"将来の夢は何ですか。", hira:"(しょうらい の ゆめ は なん です か)" },
  { en:"How do you stay positive?", jp:"どうやって前向きでいられますか。", hira:"(どうやって まえむき で いられ ます か)" },
  { en:"Who inspires you?", jp:"あなたに影響を与える人は誰ですか。", hira:"(あなた に えいきょう を あたえる ひと は だれ です か)" },
  { en:"How can English help your goals?", jp:"英語はあなたの目標にどう役立ちますか。", hira:"(えいご は あなた の もくひょう に どう やくだち ます か)" },
];

/* ===== Audio (FX + range audios) ===== */
const A_0_43  = new Audio("assets/audio/0-43.mp3");
const A_44_74 = new Audio("assets/audio/44-74.mp3");
const A_75_99 = new Audio("assets/audio/75-99.mp3");
const A_100   = new Audio("assets/audio/100.mp3");
const FART    = new Audio("assets/audio/fart.mp3");
[A_0_43,A_44_74,A_75_99,A_100,FART].forEach(a=>{a.preload="auto";a.volume=1});

/* ===== DOM ===== */
const en  = document.getElementById('en');
const jp  = document.getElementById('jp');
const hira= document.getElementById('hira');
const listenFill = document.getElementById('listenFill');
const meter = document.getElementById('meter');
const meterVal = document.getElementById('meterVal');
const beginBtn = document.getElementById('beginBtn');
const nextBtn  = document.getElementById('nextBtn');
const progress = document.getElementById('progress');
const scoreBox = document.getElementById('scoreBox');
const support  = document.getElementById('support');
const fx       = document.getElementById('fx');

/* ===== Speech Recognition Setup ===== */
const SR = (window.SpeechRecognition || window.webkitSpeechRecognition) ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
if(!SR){ support.style.display='block'; }

let idx=0;
let listening=false;
let mediaStream=null, audioCtx=null, analyser=null, dataArray=null, rafId=null;

/* Config */
const LISTEN_SECS = 6.0;  // listen window
const MIN_SCORE   = 0, MAX_SCORE = 100;

/* ===== Helpers ===== */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
function stripPunct(s){ return s.toLowerCase().replace(/[^a-z0-9' ]+/g,' ').replace(/\s+/g,' ').trim(); }

/* Levenshtein distance for normalized score */
function levenshtein(a,b){
  const m = a.length, n = b.length;
  const dp = Array.from({length:m+1},()=>new Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1]?0:1;
      dp[i][j] = Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+cost
      );
    }
  }
  return dp[m][n];
}
function similarityPercent(target, said){
  const a = stripPunct(target);
  const b = stripPunct(said);
  if(!b) return 0;
  const maxLen = Math.max(a.length,b.length)||1;
  const dist = levenshtein(a,b);
  const sim = 1 - (dist / maxLen);
  return Math.round(clamp(sim*100,0,100));
}

/* UI FX */
function bigHearts(el,count=35){
  const r=el.getBoundingClientRect(); const x=r.left+r.width/2, y=r.top+r.height/2;
  for(let k=0;k<count;k++){
    const h=document.createElement('div'); h.className='heart'; h.textContent='❤';
    const dx=(Math.random()*window.innerWidth-window.innerWidth/2)*0.3;
    const dy=(Math.random()*200-100)*0.3;
    h.style.left=(x+dx)+'px'; h.style.top=(y+dy)+'px';
    fx.appendChild(h);
    setTimeout(()=>h.remove(),1300);
  }
}
function hugeSmoke(el,count=18){
  const r=el.getBoundingClientRect(); const x=r.left+r.width/2, y=r.top+r.height/2;
  for(let k=0;k<count;k++){
    const s=document.createElement('div'); s.className='smoke';
    const a=(Math.random()*Math.PI)-Math.PI/2; const d=Math.random()*260;
    s.style.left=(x+Math.cos(a)*d)+'px'; s.style.top=(y+Math.sin(a)*d*0.4)+'px';
    fx.appendChild(s);
    setTimeout(()=>s.remove(),1600);
  }
}

/* Mic volume meter using WebAudio */
async function startMeter(){
  mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const src = audioCtx.createMediaStreamSource(mediaStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  dataArray = new Uint8Array(analyser.fftSize);
  src.connect(analyser);

  function tick(){
    analyser.getByteTimeDomainData(dataArray);
    // RMS volume
    let sum=0;
    for(let i=0;i<dataArray.length;i++){
      const v = (dataArray[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum/dataArray.length); // 0..~0.5
    const level = clamp(rms*2.2, 0, 1); // normalize

    // meter visuals
    meter.style.transform = `scale(${1 + level*0.08})`;
    meter.style.filter = `drop-shadow(0 0 ${6+level*18}px rgba(255,255,255,.28))`;
    meterVal.textContent = Math.round(level*100) + "%";

    rafId = requestAnimationFrame(tick);
  }
  tick();
}
function stopMeter(){
  cancelAnimationFrame(rafId);
  rafId=null;
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  if(audioCtx){ audioCtx.close(); audioCtx=null; }
  meter.style.transform='scale(1)';
  meterVal.textContent='—%';
}

/* Under-sentence progress bar */
function runListenBar(seconds){
  listenFill.style.transition='none';
  listenFill.style.width='0';
  requestAnimationFrame(()=>{
    listenFill.style.transition = `width ${seconds}s linear`;
    listenFill.style.width='100%';
  });
}

/* Score audio + fart rule */
function playScoreAudio(score){
  let a = A_0_43;
  if(score===100) a = A_100;
  else if(score>=75) a = A_75_99;
  else if(score>=44) a = A_44_74;
  else a = A_0_43;
  try{ a.currentTime=0; a.play().catch(()=>{});}catch(e){}
  if(score<50){
    setTimeout(()=>{ try{FART.currentTime=0;FART.play().catch(()=>{});}catch(e){} }, 150);
  }
}

/* Progress */
function updateProgress(){
  const n = Math.min(idx+1, ITEMS.length);
  const pct = Math.round(((idx)/ITEMS.length)*100);
  progress.textContent = `${n} / ${ITEMS.length}（${pct}%）`;
}

/* Karaoke: wrap words into spans and animate across LISTEN_SECS */
let karaokeTimer = null;
function startKaraoke(text){
  // Split on spaces but preserve punctuation in display
  const words = text.split(' ').filter(Boolean);
  const spans = words.map(w => `<span>${escapeHtml(w)}</span>`).join(' ');
  en.innerHTML = `<span class="karaoke">${spans}</span>`;
  const nodes = [...en.querySelectorAll('.karaoke span')];
  if(nodes.length===0) return;

  const step = LISTEN_SECS * 1000 / nodes.length;
  let i=0;
  function tick(){
    if(i>0) nodes[i-1].classList.remove('on');
    if(i<nodes.length){
      nodes[i].classList.add('on');
      i++;
      karaokeTimer = setTimeout(tick, step);
    }else{
      // leave last highlighted briefly, then clear
      karaokeTimer = setTimeout(()=>nodes.forEach(n=>n.classList.remove('on')), 200);
    }
  }
  tick();
}
function stopKaraoke(original){
  if(karaokeTimer) { clearTimeout(karaokeTimer); karaokeTimer=null; }
  en.textContent = original; // reset to clean text for next round or result view
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/* Show current item */
function showItem(){
  const it = ITEMS[idx];
  en.textContent = it.en;
  jp.textContent = it.jp;
  hira.textContent = it.hira || "";
  scoreBox.style.display='none';
  scoreBox.className='scoreBox';
  listenFill.style.width='0';
  updateProgress();
}

/* Begin listening round */
async function beginRound(){
  if(!SR){ return; }
  listening = true;
  beginBtn.disabled = true;
  nextBtn.style.display='none';
  scoreBox.style.display='none';

  // Start mic visuals + bar + karaoke
  await startMeter();
  runListenBar(LISTEN_SECS);
  startKaraoke(ITEMS[idx].en);

  // Speech recognition
  SR.lang = 'en-US';
  SR.continuous = true;
  SR.interimResults = true;

  let heard = "";
  SR.onresult = (e)=>{
    let txt = "";
    for(let i=e.resultIndex;i<e.results.length;i++){
      txt += e.results[i][0].transcript + " ";
    }
    heard = txt.trim();
  };
  SR.onerror = ()=>{};
  SR.onend = ()=>{ /* handled by timeout */ };
  try{ SR.start(); }catch(e){}

  // fixed listen window
  await sleep(LISTEN_SECS*1000);

  try{ SR.stop(); }catch(e){}
  stopMeter();
  stopKaraoke(ITEMS[idx].en);
  listenFill.style.transition='none';
  listening=false;

  // Score and render
  const target = ITEMS[idx].en;
  const score = similarityPercent(target, heard);
  renderScore(score);
}

/* Render score + FX */
function renderScore(score){
  scoreBox.style.display='block';
  scoreBox.textContent = `Score: ${score}%`;
  if(score>=95){
    scoreBox.classList.add('good');
    bigHearts(document.querySelector('.panel'), 40);
  }else if(score<50){
    scoreBox.classList.add('bad');
    hugeSmoke(document.querySelector('.panel'), 18);
  }else{
    scoreBox.classList.add('mid');
  }
  playScoreAudio(score);
  nextBtn.style.display='block';
  beginBtn.disabled=false;
}

/* Next item / finish */
function nextItem(){
  idx++;
  if(idx>=ITEMS.length){
    en.textContent="Great work today!";
    jp.textContent="よくがんばりました！";
    hira.textContent="";
    listenFill.style.width='0';
    beginBtn.style.display='none';
    nextBtn.style.display='none';
    scoreBox.style.display='block';
    scoreBox.textContent="Completed ✅";
    scoreBox.className='scoreBox good';
    bigHearts(document.body, 50);
    return;
  }
  showItem();
}

/* Wire up */
beginBtn.addEventListener('click', async ()=>{
  if(idx===0 && en.textContent.includes('Press Begin')) showItem();
  await beginRound();
});
nextBtn.addEventListener('click', ()=> nextItem());

/* Init */
showItem();
</script>
</body>
</html>
