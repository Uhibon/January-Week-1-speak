<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1,viewport-fit=cover" />
<title>Booha Speak & Repeat – January Week 1</title>
<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#0b1530; --ink:#fff; --outline:#ffffff26; --radius:26px;
  --pink:#ff7eb9; --mint:#a6f7b2; --blue:#7dd3fc; --yell:#fff680; --vio:#c77dff; --green:#22c55e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,"Noto Sans JP",sans-serif;-webkit-overflow-scrolling:touch}

/* Header/Footer */
header{text-align:center;padding:26px 12px 12px}
.h1{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(34px,6.2vw,56px);letter-spacing:.5px;text-transform:uppercase}
.h2{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(22px,4.5vw,36px);margin-top:6px}
.h3{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(16px,3.6vw,22px);margin-top:10px;opacity:.9}
.h4{font-weight:800;font-size:clamp(14px,3.4vw,20px);color:#cfe1ff;margin-top:2px}
footer{text-align:center;color:#c9d4ec;font-family:'Cinzel',serif;font-weight:700;padding:40px 10px}

/* Shell */
.wrap{max-width:1100px;margin:0 auto;padding:8px 16px 86px}
.panel{padding:20px;border:1px solid var(--outline);border-radius:var(--radius);
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  box-shadow:0 6px 24px rgba(0,0,0,.4)}

/* English sentence */
.card{position:relative;border:1px solid var(--outline);border-radius:var(--radius);padding:22px 16px;margin-bottom:10px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));overflow:hidden}
.en{position:relative;font-weight:900;font-size:clamp(26px,7.4vw,48px);line-height:1.22;text-align:center;letter-spacing:.2px;z-index:2}
.en .word{display:inline-block;padding:0 .06em;color:#ffffff;transition:color .25s ease}
.en .word.black{color:#000}

/* Soft wide glowing sweep (behind text) */
.sweep{position:absolute;top:0;left:-30%;width:44%;height:100%;background:radial-gradient(circle at 30% 50%, rgba(255,246,128,.9) 0%, rgba(255,246,128,.58) 40%, rgba(255,246,128,0) 80%);filter:blur(26px);border-radius:48px;z-index:1;opacity:0}

/* Support bar */
.supportBar{margin:8px 0 14px;border:1px solid var(--outline);border-radius:14px;padding:12px 14px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03))}
.jp{font-weight:700;font-size:clamp(16px,3.8vw,22px);text-align:center;color:#d8e7ff}
.hira{font-size:clamp(14px,3.4vw,18px);text-align:center;color:#bcd3ff;margin-top:6px}

/* Meter ring */
.meterWrap{display:flex;align-items:center;justify-content:center;margin:22px 0}
.meter{position:relative;width:min(64vw,290px);height:min(64vw,290px);display:grid;place-items:center}
.ring{position:absolute;inset:0;border-radius:50%;background:conic-gradient(#22c55e,#facc15,#f43f5e,#a78bfa,#60a5fa,#22c55e);
  -webkit-mask:radial-gradient(circle,transparent 60%,black 62%);mask:radial-gradient(circle,transparent 60%,black 62%);
  filter:drop-shadow(0 0 16px rgba(255,255,255,.25));animation:rainbowCycle 3s linear infinite;transition:transform .1s ease}
@keyframes rainbowCycle{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}
.meterCore{position:absolute;inset:12% 12%;border-radius:50%;background:radial-gradient(circle at 50% 40%, rgba(255,255,255,.14), rgba(255,255,255,.04));display:grid;place-items:center;text-align:center}
.meterText{font-weight:900;font-size:clamp(18px,6vw,28px);text-shadow:0 2px 0 rgba(0,0,0,.35)}

/* Buttons */
.btnRow{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{display:inline-grid;place-items:center;gap:4px;min-width:160px;border:none;border-radius:999px;padding:14px 20px;font-weight:900;font-size:clamp(18px,4vw,22px);color:#001e08;text-shadow:0 1px 0 rgba(255,255,255,.6);cursor:pointer;transition:transform .05s ease}
.btn:active{transform:scale(.97)}
.btn.begin{background:radial-gradient(circle at 30% 30%, #1ee99a, #15c473, #0ea85d);box-shadow:0 0 0 6px rgba(34,197,94,.22), 0 0 22px rgba(34,197,94,.8)}
.btn.retry{background:radial-gradient(circle at 30% 30%, #8ec5ff, #4da0ff, #1e6eff);box-shadow:0 0 0 6px rgba(77,160,255,.22), 0 0 22px rgba(77,160,255,.8);color:#00163a;text-shadow:0 1px 0 rgba(255,255,255,.55)}
.btn.next{background:radial-gradient(circle at 30% 30%, #ff9ad7, #ff6ec7, #ff4fa6);box-shadow:0 0 0 6px rgba(255,110,199,.22), 0 0 22px rgba(255,110,199,.85);color:#38001a;text-shadow:0 1px 0 rgba(255,255,255,.6)}
.btn:disabled{opacity:.45;cursor:not-allowed}

/* Progress / Score */
#progress{text-align:center;color:#cfe1ff;opacity:.9;font-weight:700;margin-top:8px}
.scoreBox{margin:14px auto 6px;max-width:620px;text-align:center;padding:14px 16px;border-radius:18px;border:1px solid var(--outline);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));font-weight:900;font-size:clamp(18px,4.2vw,24px)}
.scoreBox.good{box-shadow:0 0 28px rgba(34,197,94,.5) inset, 0 0 18px rgba(34,197,94,.35)}
.scoreBox.mid{box-shadow:0 0 28px rgba(96,165,250,.5) inset, 0 0 18px rgba(96,165,250,.35)}
.scoreBox.bad{box-shadow:0 0 28px rgba(229,57,53,.5) inset, 0 0 18px rgba(229,57,53,.35)}

/* FX */
.fx{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:1000}
.puff{position:absolute;border-radius:50%;filter:blur(.5px);animation:puffUp 1500ms ease-out forwards}
@keyframes puffUp{0%{opacity:0;transform:translate(-50%,-10px) scale(.6)}20%{opacity:.95}100%{opacity:0;transform:translate(-50%,-260px) scale(1.45)}}
.confetti{position:absolute;width:12px;height:12px;top:-20px;animation:confettiFall 3.5s linear forwards}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0)}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}
</style>
</head>
<body>
<header>
  <div class="h1">THE BOO-RICULUM</div>
  <div class="h2">SPEAK &amp; REPEAT</div>
  <div class="h3">January Week 1 – Speaking Practice</div>
  <div class="h4">１月第１週 – スピーキング練習</div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="card">
      <div class="sweep" id="sweep"></div>
      <div id="en" class="en">Press はじめる to start</div>
    </div>

    <div class="supportBar">
      <div id="jp" class="jp"></div>
      <div id="hira" class="hira"></div>
    </div>

    <div class="meterWrap">
      <div class="meter">
        <div id="ring" class="ring"></div>
        <div class="meterCore"><div id="meterText" class="meterText">リスニング中</div></div>
      </div>
    </div>

    <div class="btnRow">
      <button id="beginBtn" class="btn begin">はじめる<br><small>Begin</small></button>
      <button id="retryBtn" class="btn retry" style="display:none">もう一回<br><small>Retry</small></button>
      <button id="nextBtn" class="btn next" style="display:none">つぎへ<br><small>Next</small></button>
    </div>

    <div id="progress">０ / １５（０％）</div>
    <div id="scoreBox" class="scoreBox" style="display:none">スコア：—％</div>

    <div id="support" class="support" style="display:none;text-align:center;color:#ffcf7f;margin-top:10px">
      音声認識がこのブラウザでは使えません。Chrome または Edge を使用してください。
    </div>
  </div>
</div>

<div id="fx" class="fx"></div>
<footer>Bryan’s English School</footer>

<script>
/* ===== Data ===== */
const ITEMS = [
  { en:"What is your goal this year?", jp:"今年の目標は何ですか。", hira:"(ことし の もくひょう は なん です か)" },
  { en:"Why is it important to you?", jp:"あなたにとってなぜ大切ですか。", hira:"(あなた に とって なぜ たいせつ です か)" },
  { en:"How will you reach your goal?", jp:"どうやって目標を達成しますか。", hira:"(どうやって もくひょう を たっせい します か)" },
  { en:"Who helps you stay motivated?", jp:"やる気を保つのを誰が助けてくれますか。", hira:"(やるき を たもつ の を だれ が たすけて くれ ます か)" },
  { en:"What habit do you want to change?", jp:"変えたい習慣は何ですか。", hira:"(かえたい しゅうかん は なん です か)" },
  { en:"Do you like making resolutions?", jp:"新年の目標を立てるのは好きですか。", hira:"(しんねん の もくひょう を たてる の は すき です か)" },
  { en:"What do you want to try this year?", jp:"今年挑戦したいことは何ですか。", hira:"(ことし ちょうせん したい こと は なん です か)" },
  { en:"What’s something new you learned recently?", jp:"最近新しく学んだことは何ですか。", hira:"(さいきん あたらしく まなんだ こと は なん です か)" },
  { en:"Is it easy to keep goals?", jp:"目標を続けるのは簡単ですか。", hira:"(もくひょう を つづける の は かんたん です か)" },
  { en:"What happens when you don’t try?", jp:"挑戦しないとどうなりますか。", hira:"(ちょうせん しない と どう なり ます か)" },
  { en:"What makes you feel proud?", jp:"何があなたを誇らしくさせますか。", hira:"(なに が あなた を ほこらしく させ ます か)" },
  { en:"What’s your dream for the future?", jp:"将来の夢は何ですか。", hira:"(しょうらい の ゆめ は なん です か)" },
  { en:"How do you stay positive?", jp:"どうやって前向きでいられますか。", hira:"(どうやって まえむき で いられ ます か)" },
  { en:"Who inspires you?", jp:"あなたに影響を与える人は誰ですか。", hira:"(あなた に えいきょう を あたえる ひと は だれ です か)" },
  { en:"How can English help your goals?", jp:"英語はあなたの目標にどう役立ちますか。", hira:"(えいご は あなた の もくひょう に どう やくだち ます か)" },
];

/* ===== Range Audios ===== */
const A_0_43  = new Audio("assets/audio/0-43.mp3");
const A_44_74 = new Audio("assets/audio/44-74.mp3");
const A_75_99 = new Audio("assets/audio/75-99.mp3");
const A_100   = new Audio("assets/audio/100.mp3");
[A_0_43,A_44_74,A_75_99,A_100].forEach(a=>{a.preload="auto";a.volume=1});

/* ===== DOM ===== */
const enEl  = document.getElementById('en');
const jpEl  = document.getElementById('jp');
const hiraEl= document.getElementById('hira');
const beginBtn = document.getElementById('beginBtn');
const retryBtn = document.getElementById('retryBtn');
const nextBtn  = document.getElementById('nextBtn');
const progress = document.getElementById('progress');
const scoreBox = document.getElementById('scoreBox');
const support  = document.getElementById('support');
const fx       = document.getElementById('fx');
const ring     = document.getElementById('ring');
const meterText= document.getElementById('meterText');
const sweep    = document.getElementById('sweep');

/* ===== Config/Utils ===== */
const LISTEN_SECS = 3.0; // fixed ESL reading speed
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
function strip(s){ return s.toLowerCase().replace(/[^a-z0-9' ]+/g,' ').replace(/\s+/g,' ').trim(); }
function playAudioSafe(a){ try{ a.pause(); a.currentTime=0; const p=a.play(); if(p&&p.then)p.catch(()=>{});}catch(e){} }
function toFW(n){ return n.toString().replace(/\d/g, d=>"０１２３４５６７８９"[d]); }

/* ===== Mount words ===== */
let wordsMeta=null,sweepRAF=null;
function mountWords(text){
  const parts = text.split(/\s+/).filter(Boolean);
  enEl.innerHTML = parts.map(w=>`<span class="word">${w}</span>`).join(' ');
  wordsMeta = [...enEl.querySelectorAll('.word')];
}

/* ===== Soft yellow sweep behind text ===== */
function startSweep(durationMs=LISTEN_SECS*1000){
  sweep.style.opacity=1;
  const rect = enEl.getBoundingClientRect();
  const total = rect.width || 1;
  const start = performance.now();
  cancelAnimationFrame(sweepRAF);
  function step(t){
    const elapsed = t - start;
    const prog = Math.min(elapsed/durationMs, 1);
    const x = total * prog;
    sweep.style.left = (x - total*0.30) + 'px';
    for(const w of wordsMeta){
      const r = w.getBoundingClientRect();
      const cx = r.left + r.width/2 - rect.left;
      w.classList.toggle('black', cx <= x);
    }
    if(elapsed < durationMs){ sweepRAF = requestAnimationFrame(step); }
    else { sweep.style.opacity = 0; }
  }
  sweepRAF = requestAnimationFrame(step);
}

/* ===== Keyword scoring (simple) ===== */
function keywordScore(target, transcript){
  const keys = strip(target).split(' ').filter(w=>w.length>2);
  const said = ' ' + strip(transcript) + ' ';
  let hit=0; for(const k of keys){ if(said.includes(' '+k+' ')) hit++; }
  return Math.round((hit/keys.length)*100);
}

/* ===== Reactive mic ring ===== */
let audioCtx=null, mediaStream=null, analyser=null, dataArray=null, rafId=null;
async function startRing(){
  try{ mediaStream = await navigator.mediaDevices.getUserMedia({audio:true}); }
  catch(e){ return; }
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  await audioCtx.resume();
  const src = audioCtx.createMediaStreamSource(mediaStream);
  analyser = new AnalyserNode(audioCtx, {fftSize:2048});
  dataArray = new Uint8Array(analyser.fftSize);
  src.connect(analyser);
  let smooth=0;
  function tick(){
    analyser.getByteTimeDomainData(dataArray);
    let sum=0; for(let i=0;i<dataArray.length;i++){ const v=(dataArray[i]-128)/128; sum+=v*v; }
    const rms = Math.sqrt(sum/dataArray.length);
    const level = clamp(rms*3,0,1);
    smooth = smooth*0.8 + level*0.2;
    ring.style.transform = `scale(${1 + smooth*0.35})`;
    rafId = requestAnimationFrame(tick);
  }
  tick();
}
function stopRing(){
  cancelAnimationFrame(rafId); rafId=null;
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  if(audioCtx){ audioCtx.close(); audioCtx=null; }
  ring.style.transform='scale(1)';
}

/* ===== Progress / Item show ===== */
let idx=0; let SR=(window.SpeechRecognition||window.webkitSpeechRecognition) ? new (window.SpeechRecognition||window.webkitSpeechRecognition)() : null;
if(!SR){ support.style.display='block'; }
let transcriptHeard="";
function updateProgress(){
  const n = Math.min(idx+1, ITEMS.length);
  const pct = Math.round((idx/ITEMS.length)*100);
  progress.textContent = `${toFW(n)} / ${toFW(ITEMS.length)}（${toFW(pct)}％）`;
}
function showItem(){
  const it = ITEMS[idx];
  mountWords(it.en);
  jpEl.textContent = it.jp;
  hiraEl.textContent = it.hira || "";
  scoreBox.style.display='none'; scoreBox.className='scoreBox';
  meterText.textContent='リスニング中';
  updateProgress();
}

/* ===== Render score + FX ===== */
function renderScore(score){
  const s = clamp(score,0,100);
  meterText.textContent = `${s}%`;
  let msg = `スコア：${s}％`;
  if(s<=43) msg += "　｜　ブーーッ！もう一回！";
  else if(s<=74) msg += "　｜　もう少し！";
  else if(s<100) msg += "　｜　よくできました！";
  else msg += "　｜　パーフェクト！！";
  scoreBox.textContent = msg;
  scoreBox.style.display='block';
  scoreBox.className='scoreBox ' + (s>=95 ? 'good' : (s<50 ? 'bad' : 'mid'));
  if(s===100) playAudioSafe(A_100);
  else if(s>=75) playAudioSafe(A_75_99);
  else if(s>=44) playAudioSafe(A_44_74);
  else playAudioSafe(A_0_43);
  const panel=document.querySelector('.panel');
  if(s===100) confetti(240);
  else if(s>=75) confetti(120);
  else if(s>=44) puffs(panel, 22, 'rgba(255,255,255,0.92)');
  else puffs(panel, 28, 'rgba(106,77,43,0.95)');
  nextBtn.style.display='inline-block';
  beginBtn.disabled=false;
  retryBtn.style.display = (s<75) ? 'inline-block' : 'none';
}

/* ===== Round flow ===== */
async function beginRound(){
  if(!SR){ // no recognition available: still show meter + sweep
    startSweep();
    await startRing();
    await sleep(LISTEN_SECS*1000);
    stopRing();
    renderScore(100); // best effort visual-only mode
    return;
  }
  beginBtn.disabled=true; retryBtn.style.display='none'; nextBtn.style.display='none'; scoreBox.style.display='none';
  transcriptHeard="";
  await startRing();
  startSweep();
  SR.lang='en-US'; SR.continuous=true; SR.interimResults=true;
  SR.onresult=(e)=>{ let txt=""; for(let i=e.resultIndex;i<e.results.length;i++){ txt+=e.results[i][0].transcript+" "; } transcriptHeard=txt.trim(); };
  try{ SR.start(); }catch(e){}
  await sleep(LISTEN_SECS*1000);
  try{ SR.stop(); }catch(e){}
  stopRing();
  const s = keywordScore(ITEMS[idx].en, transcriptHeard);
  renderScore(s);
}

function nextItem(){
  idx++;
  if(idx>=ITEMS.length){
    enEl.innerHTML="Great work today!";
    jpEl.textContent="よくがんばりました！";
    hiraEl.textContent="";
    scoreBox.style.display='block'; scoreBox.textContent="ぜんぶできました！おつかれさま！";
    confetti(180);
    beginBtn.style.display='none'; retryBtn.style.display='none'; nextBtn.style.display='none';
    return;
  }
  showItem();
}

/* ===== FX helpers ===== */
function puffs(el,count,color){
  const r=el.getBoundingClientRect(); const x=r.left+r.width/2, y=r.top+r.height/2+20;
  for(let k=0;k<count;k++){
    const s=document.createElement('div'); s.className='puff';
    const size=Math.random()*120+50;
    s.style.width=size+'px'; s.style.height=size+'px';
    s.style.left=(x+(Math.random()*280-140))+'px';
    s.style.top=(y+(Math.random()*60-20))+'px';
    s.style.background=`radial-gradient(circle at 40% 40%, ${color}, rgba(0,0,0,0))`;
    fx.appendChild(s); setTimeout(()=>s.remove(),1600);
  }
}
function confetti(count=120){
  const colors=['#ff7eb9','#a6f7b2','#7dd3fc','#fff680','#c77dff','#8aff80'];
  for(let i=0;i<count;i++){
    const c=document.createElement('div'); c.className='confetti';
    c.style.background=colors[(Math.random()*colors.length)|0];
    c.style.left=Math.random()*100+'vw';
    c.style.animationDelay=(Math.random()*1.6)+'s';
    c.style.width=(8+Math.random()*10)+'px'; c.style.height=c.style.width;
    fx.appendChild(c); setTimeout(()=>c.remove(),3800);
  }
}

/* ===== Mobile audio unlock ===== */
let unlocked=false;
function unlock(){ if(unlocked) return; try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); ctx.resume().finally(()=>ctx.close()); }catch(e){} [A_0_43,A_44_74,A_75_99,A_100].forEach(a=>{ try{ a.play().then(()=>a.pause()).catch(()=>{});}catch(e){} }); unlocked=true; }

/* ===== Wire up ===== */
beginBtn.addEventListener('click', async ()=>{ unlock(); if(idx===0 && jpEl.textContent===""){ showItem(); } await beginRound(); });
retryBtn.addEventListener('click', async ()=>{ await beginRound(); });
nextBtn.addEventListener('click', ()=> nextItem());

/* ===== Init ===== */
(function init(){ showItem(); })();
</script>
</body>
</html>
